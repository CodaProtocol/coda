version: 2
jobs:
  build:
    resource_class: xlarge
    docker:
      - image: gcr.io/o1labs-192920/ocaml-base:d84b51cbbf0549bf5df06c89bd14c297553fd9d7
        # ENV variable is located in circleci
        auth:
          username: _json_key
          password: $JSON_GCLOUD_CREDENTIALS
    steps:
      - checkout

      - run:
          name: Lint
          command: eval `opam config env` && make check-format

      - run:
          name: Build Haskell
          command: source ~/.profile && cd app/kademlia-haskell && nix-build release2.nix

      - run:
          name: Build OCaml
          command: eval `opam config env` && dune build -j8 | tee build.log

      - run:
          name: Count OCaml Warns
          command: ./scripts/buildwarns.py build.log

      - run:
          name: Run All Tests
          command: source ~/.profile && PATH="$PATH:$(nix-shell . --run 'dirname $(which spirv-val)')" make test

