load("@rules_foreign_cc//tools/build_defs:make.bzl", "make")

# TODO: number of jobs for Linux, Darin
make(
    name = "rocksdb",
    visibility = ["//visibility:public"],
    static_libraries = ["librocksdb.a"],
    make_commands = [
        " ".join(["env",
                  "ROCKSDB_DISABLE_SNAPPY=1",
                  "ROCKSDB_DISABLE_GFLAGS=1",
                  "ROCKSDB_DISABLE_LZ4=1",
                  "ROCKSDB_DISABLE_ZSTD=1",
                  "ROCKSDB_DISABLE_NUMA=1",
                  "ROCKSDB_DISABLE_TBB=1",
                  "ROCKSDB_DISABLE_JEMALLOC=1",
                  "ROCKSDB_DISABLE_TCMALLOC=1",
                  "ROCKSDB_DISABLE_BACKTRACE=1",
                  "PORTABLE=1",
                  "FORCE_SSE42=1",
                  "DISABLE_WARNING_AS_ERROR=1",
                  "make", "static_lib", "-j2",
                  ]),
        " ".join(["env",
                  "ROCKSDB_DISABLE_SNAPPY=1",
                  "ROCKSDB_DISABLE_GFLAGS=1",
                  "ROCKSDB_DISABLE_LZ4=1",
                  "ROCKSDB_DISABLE_ZSTD=1",
                  "ROCKSDB_DISABLE_NUMA=1",
                  "ROCKSDB_DISABLE_TBB=1",
                  "ROCKSDB_DISABLE_JEMALLOC=1",
                  "ROCKSDB_DISABLE_TCMALLOC=1",
                  "ROCKSDB_DISABLE_BACKTRACE=1",
                  "PORTABLE=1",
                  "FORCE_SSE42=1",
                  "DISABLE_WARNING_AS_ERROR=1",
                  "INSTALL_PATH=${INSTALLDIR}",
                  "make", "install-static"
                  ]),
    ],
    postfix_script = "strip -S librocksdb.a",
    lib_source = "@rocksdb//:all",
)
