# Hardware wallets

Coda now supports the usage of hardware wallets such as Ledger to interact with the protocol, and sign transactions.

## Requirements

**Software**: Linux (currently supports Debian 9 and Ubuntu 18.04 LTS)

Note: macOS and Windows are not officially supported at this time.

**Hardware**: Currently only `Ledger Nano S` is supported

## Installation

**Disclaimer**: This is still highly experimental -- use cautiously, as these instructions may change. Once the hardware wallet app is available on [Ledger Live](https://www.ledger.com/ledger-live), the installation steps will be stabilized.

The following debian packages are needed to use hardware wallets on linux:
```
sudo apt install libusb-1.0-0-dev libudev1 libudev-dev
```

### Make sure your computer is recognising the Ledger device
- Plug in the Ledger device, unlock, go to menu (not inside any app!)
- Run `lsusb`, see if the device is listed. It will have ID `2c97:0001`
  - If not, see if these instructions help https://support.ledger.com/hc/en-us/articles/115005165269-Fix-connection-issues
  - Get into the menu of the ledger by clicking both buttons — it shouldnt say ‘go to ledger live to install applications’ and should show the settings menu and two arrows

### Build/download the Coda Ledger application

Either download the precompiled app binary from [here](...).

#### System-wide installation
Or install gcc and clang. 
This can be done in two ways. You can install them with 
` sudo apt install gcc clang`

#### Downloading precompiled gcc and clang
Or , following the instructions at [the Ledger Wiki](https://ledger.readthedocs.io/en/latest/userspace/getting_started.html):
- Install standard gcc (for microcontroller firmware and secure device linking)
(link from ledger link?), by downloading a precompiled binary from [here](https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-rm/downloads)
- Install a standard clang with ROPI support (for secure processor applications), following the instructions [here](https://clang.llvm.org/get_started.html) to build from source or download a precompiled binary.
- Once you have downloaded the binaries, unzip and install them, for example with 
  `cd Downloads`
  `tar -xf clang+llvm-7.0.0-x86_64-linux-gnu-ubuntu-16.04.tar.xz`
  `bzip2 -dk gcc-arm-none-eabi-5_3-2016q1tar.bz2`
  and then add them to your PATH with
  ```
  # GCC
  PATH=~/bolos-devenv/gcc-arm-none-eabi-5_3-2016q1/bin:$PATH
  # Clang
  PATH=~/bolos-devenv/clang+llvm-7.0.0-x86_64-linux-gnu-ubuntu-16.04/bin:$PATH
  ```


Next, use `sudo apt install gcc-multilib g++-multilib` or equivalent to install the cross compilation 
headers required. 
Then install the Nano S SDK with 
```
git clone git@github.com:LedgerHQ/nanos-secure-sdk.git
```
and add `export BOLOS_SDK=<PATH-TO-SDK>` to your `~/.bashrc` or `~/.profile`.

### Install the python app loader

The Ledger python loader exists [here](https://github.com/LedgerHQ/blue-loader-python) 
and can also be downloaded/installed with the following:
```
sudo apt install -y libudev-dev libusb
pip install ledgerblue
pip3 install ledgerblue
```

After installing, when running on Linux, make sure the following rules have been added to `/etc/udev/rules.d/`
(eg with `sudo vim /etc/udev/rules.d/20-hw1.rules`), changing `<UNIX username>` to your unix username:

```
SUBSYSTEMS=="usb", ATTRS{idVendor}=="2c97", ATTRS{idProduct}=="0000", MODE="0660", TAG+="uaccess", TAG+="udev-acl" OWNER="<UNIX username>"
SUBSYSTEMS=="usb", ATTRS{idVendor}=="2c97", ATTRS{idProduct}=="0001", MODE="0660", TAG+="uaccess", TAG+="udev-acl" OWNER="<UNIX username>"
SUBSYSTEMS=="usb", ATTRS{idVendor}=="2c97", ATTRS{idProduct}=="0004", MODE="0660", TAG+="uaccess", TAG+="udev-acl" OWNER="<UNIX username>"
```

### Download the Coda Ledger app
Running the following will install the Coda app on your Ledger device:
```
git clone git@github.com:CodaProtocol/ledger-coda-app.git
cd ledger-coda-app
make load
```

The coda hardware wallet command line tool is a python package called `coda-ledger-cli`:
```
python3 -mpip install coda-ledger-cli 
```

If you have connection issues with your hardware wallet, please take a look at [the troubleshooting help on the Ledger support page](https://support.ledger.com/hc/en-us/articles/115005165269-Fix-connection-issues).
Oftentimes, connectivity issues can be resolved by adding udev rules. Enter the following command to automatically add the rules and reload udev:
```
wget -q -O - https://raw.githubusercontent.com/LedgerHQ/udev-rules/master/add_udev_rules.sh | sudo bash
```

## Create a new account using the hardware wallet

Run the following command which will create a public and private keypair in the hardware wallet:

    coda accounts create-hd HD-index

HD-index is a number that works like a seed that you give to the hardware wallet to create your public and private keypair. If you use the same HD-index with the same hardware wallet twice, then public and private keypair that gets generated is the same. If you need to use the same account on another machine, then you just need to use this command with the same HD-index and the same hardware wallet.

During account creation, your hardware wallet may ask you to confirm the operation.

The response from this command will look like this:

    Keypair generated
    Public key:  4vsRCVbLm6LvUyzYWT95WaCzyi4D4UHxRpLBhMn7q2mRPgNCgRG3Jr3tDuhgQdmzbvCcBxhUwB3REpY2Dyf1NAxSSs8Q2vdJX93pT7eyqcyRU2S9UpDddDgovj46BSknNjzydKoopebp5Kva

Since the public key is quite long and difficult to remember, let's save it as an environment variable:

    export CODA_PUBLIC_KEY=<YOUR-PUBLIC-KEY>

Now we can access this everywhere as `$CODA_PUBLIC_KEY` -- see if it saved properly by trying `echo $CODA_PUBLIC_KEY`.

## Make a payment

Sending a payment with a hardware wallet is almost the same as send a payment from an ordinary account.

There are only 2 differences:
1. You do not need to unlock your account before sending the transaction because your account is protected by your hardware wallet already.
2. Your hardware wallet may ask you to confirm the operation while signing the transaction.

You can simply use the same commands to send payments found in [the docs](/docs/my-first-transaction/).

## Troubleshooting

### What if I lose my hardware wallet?
You can buy another `Ledger Nano S` and initialize it with the same 24-word seed to gain access to your existing account.

### What if I forget the public key of my account?
If you remember the HD-index which you use to generate your account, then you can use `coda accounts create-hd HD-index` with the same HD-index to regenerate the public_key.
